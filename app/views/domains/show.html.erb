<%
  periods       = ['1 day', '1 week','2 week','1 month','6 months','1 year']
  params_period = params[:period] || '1week'
  period_name   = params_period.gsub(/\d/, '\\0 ')
  quantity      = params_period.gsub(/\D/,'').to_i
  unit          = params_period.gsub(/\d/,'')
  start_date    = quantity.send(unit).ago.midnight

  charts = [
    TopSources.new(domain: @domain, start_date: start_date),
    TopPages.new(domain: @domain, start_date: start_date),
    Devices.new(domain: @domain, start_date: start_date),
    TopHours.new(domain: @domain, start_date: start_date),
    TopLocations.new(domain: @domain, start_date: start_date)
  ]
%>

<%= render @domain %>

<div class="container is-fluid mb-6">
  <%= link_to "Edit this domain", edit_domain_path(@domain) %> |
  <%= link_to "Back to domains", domains_path %>
  <%= button_to "Destroy this domain", @domain, method: :delete %>
  <div class="block is-flex is-flex-direction-row is-justify-content-space-between is-align-items-center">
    <div class="is-flex is-flex-direction-row is-align-items-center">
      <figure class="image is-48x48 m-3">
        <img class="is-rounded" src="<%= @domain.icon_url %>">
      </figure>
      <h1 class="title"><%= @domain.name %></h1>
    </div>
    <div class="">
      <div class="dropdown">
        <div class="dropdown-trigger">
          <button class="button" aria-haspopup="true" aria-controls="dropdown-menu">
            <span><%= period_name %></span>
            <span class="icon is-small">
              <i class="fas fa-angle-down" aria-hidden="true"></i>
            </span>
          </button>
        </div>
        <div class="dropdown-menu" id="dropdown-menu" role="menu">
          <div class="dropdown-content">
            <% periods.each do |p| %>
              <a href="?period=<%= p.gsub(' ','') %>" class="dropdown-item <%= 'is-active' if p.gsub(' ','') == params_period %>">
                <%= p %>
              </a>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div>
    <%= render(TopStats.new(domain: @domain, start_date: start_date)) %>
    <div class="box">
      <%= render(Visits.new(domain: @domain, start_date: start_date)) %>
    </div>
    <div class="columns is-multiline">
      <% charts.each do |chart| %>
        <div class="column is-half">
          <div class="box">
            <%= render(chart) %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%= javascript_tag do %>
  var dropdown = document.querySelector('.dropdown');
  dropdown.addEventListener('click', function(event) {
  event.stopPropagation();
  dropdown.classList.toggle('is-active');
  });
<% end %>
